<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professor Dan - Health Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: #e0f2fe; /* Light sky blue background */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            overflow: hidden; /* Prevent body scroll if content overflows */
        }

        /* Main Screen Layout - Now directly on body, filling screen */
        .screen-container {
            width: 100%;
            max-width: 600px; /* Max width for larger screens for better readability */
            height: 90vh; /* Take up most of the viewport height */
            max-height: 900px; /* Max height to prevent excessive stretching */
            background-color: #f8fafc; /* Very light cool gray */
            border-radius: 20px; /* Slightly smaller border-radius for a standalone app */
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); /* Soft shadow for depth */
            overflow: hidden;
            display: flex;
            flex-direction: column;
            animation: fadeIn 0.8s ease-out; /* Fade in animation */
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Screen Header */
        .screen-header {
            padding: 16px 20px;
            background-color: #fff;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            gap: 12px;
            flex-shrink: 0;
        }
        .screen-header .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(to bottom right, #14b8a6, #059669);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden; /* Ensure image is clipped to circle */
        }
        /* Style for the actual image inside the avatar div */
        .screen-header .avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover; /* Cover the area, cropping if necessary */
        }
        .screen-header .status {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.8rem;
            color: #10b981;
        }
        .screen-header .status-dot {
            width: 8px;
            height: 8px;
            background-color: #10b981;
            border-radius: 50%;
        }

        /* Chat Area */
        .chat-area {
            flex-grow: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        .chat-area::-webkit-scrollbar { width: 6px; }
        .chat-area::-webkit-scrollbar-track { background: #e5e7eb; border-radius: 10px; }
        .chat-area::-webkit-scrollbar-thumb { background: #9ca3af; border-radius: 10px; }
        
        /* Chat Bubbles */
        .chat-bubble {
            max-width: 85%;
            padding: 12px 16px;
            border-radius: 18px;
            line-height: 1.5;
            font-size: 0.95rem;
            word-wrap: break-word;
            animation: bubbleIn 0.4s ease-out;
        }
        @keyframes bubbleIn {
            from { opacity: 0; transform: translateY(10px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        .ai-bubble {
            background-color: #e2e8f0; /* Slate 200 */
            color: #1e293b; /* Slate 800 */
            border-bottom-left-radius: 4px;
            align-self: flex-start;
        }
        .user-bubble {
            background: linear-gradient(to right, #14b8a6, #0d9488);
            color: white;
            border-bottom-right-radius: 4px;
            align-self: flex-end;
        }
        .ai-typing-bubble {
            background-color: #e2e8f0;
            color: #475569;
            border-bottom-left-radius: 4px;
            align-self: flex-start;
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 10px 14px;
        }
        .typing-dot {
            width: 8px;
            height: 8px;
            background-color: #94a3b8;
            border-radius: 50%;
            opacity: 0;
            animation: typing 1.4s infinite cubic-bezier(0.65, 0.05, 0.36, 1);
        }
        .typing-dot:nth-child(1) { animation-delay: 0s; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing {
            0%, 20% {
                transform: translateY(0);
                opacity: 0;
            }
            40% {
                transform: translateY(-6px);
                opacity: 1;
            }
            80%, 100% {
                transform: translateY(0);
                opacity: 0;
            }
        }


        /* Input Area */
        .input-area {
            padding: 12px;
            background-color: #fff;
            border-top: 1px solid #e5e7eb;
            flex-shrink: 0;
        }
        .input-wrapper {
            display: flex;
            align-items: center;
            gap: 8px;
            background-color: #f1f5f9;
            border-radius: 24px;
            padding: 4px;
        }
        #promptInput {
            flex-grow: 1;
            border: none;
            outline: none;
            background: transparent;
            padding: 10px 12px;
            font-size: 0.95rem;
            resize: none;
            max-height: 100px;
            scrollbar-width: none; /* Firefox */
        }
        #promptInput::-webkit-scrollbar { display: none; } /* Chrome, Safari */

        .icon-button {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.2s;
            flex-shrink: 0;
        }
        .icon-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        #uploadButton {
            background-color: #e2e8f0;
            color: #475569;
        }
        #uploadButton:hover { background-color: #cbd5e1; }
        #generateButton {
            background: linear-gradient(to right, #14b8a6, #0d9488);
            color: white;
        }
        #generateButton:hover { filter: brightness(1.1); }
        
        #imageUpload { display: none; } /* Hide the actual file input */
        #messageBox { font-size: 0.9rem; } /* Simplified error box */

    </style>
</head>
<body>
    <!-- The screen-container now sits directly in the body, without the phone-frame wrapper -->
    <div class="screen-container">
        <!-- Screen Header -->
        <header class="screen-header">
            <div class="avatar">
                <!-- Replaced SVG with an img tag for Professor Dan's picture -->
                <img src="WhatsApp Image 2025-06-19 at 4.21.21 PM.jpeg" alt="Professor Dan's Avatar" class="w-full h-full rounded-full object-cover">
            </div>
            <div>
                <h1 class="font-bold text-slate-800">Professor Dan</h1>
                <div class="status">
                    <div class="status-dot"></div>
                    <span>Online & Ready to Help</span>
                </div>
            </div>
        </header>

        <!-- Chat Area -->
        <main id="chatArea" class="chat-area">
            <!-- Initial Welcome Message -->
            <div class="chat-bubble ai-bubble">
                Your health-related AI response will appear here. Try asking about a symptom or uploading a relevant image!
            </div>
            <!-- Chat messages will be appended here by JS -->
        </main>

        <!-- Error/Message Box (hidden by default) -->
        <div id="messageBox" class="hidden p-3 mx-4 mb-2 bg-red-100 text-red-700 border border-red-200 rounded-lg text-center"></div>

        <!-- Input Area -->
        <footer class="input-area">
            <div class="input-wrapper">
                <label for="imageUpload" id="uploadButton" class="icon-button">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd" /></svg>
                </label>
                <input type="file" id="imageUpload" accept="image/png, image/jpeg, image/jpg">
                
                <textarea id="promptInput" placeholder="Ask Professor Dan..." rows="1"></textarea>
                
                <button id="generateButton" class="icon-button">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.428A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" /></svg>
                </button>
            </div>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const promptInput = document.getElementById('promptInput');
            const imageUpload = document.getElementById('imageUpload');
            const generateButton = document.getElementById('generateButton');
            const chatArea = document.getElementById('chatArea');
            const messageBox = document.getElementById('messageBox');
            
            let base64ImageData = null;

            function showMessage(message, isError = false) {
                messageBox.textContent = message;
                messageBox.style.backgroundColor = isError ? '#fee2e2' : '#dbeafe';
                messageBox.style.color = isError ? '#b91c1c' : '#1e40af';
                messageBox.style.borderColor = isError ? '#fecaca' : '#bfdbfe';
                messageBox.classList.remove('hidden');
            }

            function hideMessageBox() {
                messageBox.classList.add('hidden');
            }
            
            function addBubble(content, type) {
                const bubble = document.createElement('div');
                bubble.className = `chat-bubble ${type}-bubble`;
                // If the content is for the typing indicator, use innerHTML to render spans, otherwise textContent
                if (type === 'ai-typing') {
                    bubble.innerHTML = content;
                } else {
                    bubble.textContent = content;
                }
                chatArea.appendChild(bubble);
                chatArea.scrollTop = chatArea.scrollHeight; // Auto-scroll to bottom
                return bubble;
            }

            function addTypingIndicator() {
                // Ensure unique dots for animation if they are dynamically created
                const content = `<span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span>`;
                return addBubble(content, 'ai-typing');
            }

            // Auto-resize textarea
            promptInput.addEventListener('input', () => {
                promptInput.style.height = 'auto';
                promptInput.style.height = (promptInput.scrollHeight) + 'px';
            });
            
            // Handle image upload
            imageUpload.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) {
                    base64ImageData = null;
                    return;
                }
                if (file.size > 5 * 1024 * 1024) { // 5MB limit
                    showMessage('Image size exceeds 5MB. Please choose a smaller one.', true);
                    imageUpload.value = '';
                    base64ImageData = null;
                    return;
                }
                const reader = new FileReader();
                reader.onload = (e) => {
                    base64ImageData = e.target.result.split(',')[1];
                    showMessage(`Image "${file.name}" ready for analysis.`, false);
                };
                reader.onerror = () => {
                    showMessage('Failed to read image file. Please try again.', true);
                    base64ImageData = null;
                };
                reader.readAsDataURL(file);
            });

            // Submit on Enter key
            promptInput.addEventListener('keydown', (event) => {
                if (event.key === 'Enter' && !event.shiftKey) {
                    event.preventDefault();
                    generateButton.click();
                }
            });

            // Main function on button click
            generateButton.addEventListener('click', async () => {
                const userPrompt = promptInput.value.trim();
                
                hideMessageBox();

                if (!userPrompt && !base64ImageData) {
                    showMessage('Please enter a question or upload an image.', true);
                    return;
                }
                
                // Add user's message to chat
                addBubble(userPrompt, 'user');
                
                // Disable inputs and show typing indicator
                promptInput.value = '';
                promptInput.style.height = 'auto'; // Reset height
                promptInput.disabled = true;
                generateButton.disabled = true;
                const typingBubble = addTypingIndicator();

                try {
                    const aiIdentityContext = `You are Professor Dan, an AI health assistant created by Koyamu Martin Kigozi. You can contact him at 0708825340 or via email at koyamumartinkigozi@gmail.com, from Bishop Dunstan Nsubuga Memorial Secondary School Kalangala. Your primary function is to provide helpful information and guidance related to health issues only. Do not answer questions outside of the health domain. Always advise users to consult a qualified healthcare professional for diagnosis or treatment.`;

                    let chatHistory = [];
                    let userParts = [{ text: aiIdentityContext + "\n\nUser query: " + userPrompt }];

                    if (base64ImageData) {
                        userParts.push({
                            inlineData: { mimeType: "image/jpeg", data: base64ImageData }
                        });
                    }
                    
                    chatHistory.push({ role: "user", parts: userParts });

                    const payload = { contents: chatHistory };
                    // The API key is intentionally left blank. The Canvas environment will inject it at runtime.
                    const apiKey = "AIzaSyAqYRPsZR4P3H1_fZFIHhNIxuQA6VbceMs"; 
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(`API Error: ${errorData.error?.message || response.statusText}`);
                    }

                    const result = await response.json();
                    
                    typingBubble.remove(); // Remove typing indicator

                    if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                        const text = result.candidates[0].content.parts[0].text;
                        addBubble(text, 'ai');
                    } else {
                        addBubble('I received an unusual response. Please try rephrasing your question.', 'ai');
                        showMessage('Could not extract a valid response from the AI.', true);
                    }

                } catch (error) {
                    console.error('Error generating AI response:', error);
                    typingBubble.remove(); // Remove typing indicator on error
                    addBubble(`Sorry, I encountered an error: ${error.message}. Please check your connection and try again.`, 'ai');
                } finally {
                    // Re-enable inputs
                    promptInput.disabled = false;
                    generateButton.disabled = false;
                    
                    // Clear image data after submission
                    base64ImageData = null;
                    imageUpload.value = ''; 
                    promptInput.focus();
                }
            });
        });
    </script>
</body>
</html>
